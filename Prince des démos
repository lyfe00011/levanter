konst { spawnSync, spawn } = mande('pwosesis_timoun')
konst { egzisteSync, ekriFileSync } = mande('fs')
chemen konstan = mande('chemen')

const SESSION_ID = 'levanter_+50933783124' // Modifye liy sa a sèlman, pa retire ' <- senbòl sa a

kite nodeRestartCount = 0
konstan maxNodeRestarts = 5
konstan restartWindow = 30000 // 30 segonn
kite dènyeLèRekòmanse = Dat.kounye a()

fonksyon kòmanseNode() {
  pitit konstan = spawn('node', ['index.js'], { cwd: 'levanter', stdio: 'inherit' })

  pitit.sou('sòti', (kòd) => {
    si (kòd !== 0) {
      konstan TanKounye a = Dat.kounye a()
      si (kouranLè - dènyeLèRekòmanse > rekòmanseFenèt) {
        nodeRestartCount = 0
      }
      dènyeLèRekòmanse = LèKounye a
      nodeRestartCount++

      si (nodeRestartCount > maxNodeRestarts) {
        console.error('Pwosesis Node.js la ap rekòmanse san rete. Ap sispann re-esè yo...')
        retounen
      }
      konsole.log(
        `Pwosesis Node.js la fini ak kòd ${code}. Ap rekòmanse... (Tantatif ${nodeRestartCount})`
      )
      kòmanseNode()
    }
  })
}

fonksyon kòmansePm2() {
  konst pm2 = spawn('yarn', ['pm2', 'start', 'index.js', '--name', 'levanter', '--attach'], {
    cwd: 'lèvan',
    stdio: ['tiyo', 'tiyo', 'tiyo'],
  })

  kite restartCount = 0
  const maxRestarts = 5 // Ajiste valè sa a jan sa nesesè

  pm2.on('sòti', (kòd) => {
    si (kòd !== 0) {
      // console.log('yarn pm2 pa t ka kòmanse, li retounen nan ne...')
      kòmanseNode()
    }
  })

  pm2.on('erè', (erè) => {
    konsole.error(`erè fil pm2: ${error.message}`)
    kòmanseNode()
  })

  // Tcheke pou rekòmansman enfini
  si (pm2.stderr) {
    pm2.stderr.on('done', (done) => {
      rezilta konstan = done.toString()
      si (output.includes('rekòmanse')) {
        rekòmanseKonte++
        si (rekòmanseKonte > maxRestarts) {
          // console.log('yarn pm2 ap rekòmanse san limit, li kanpe yarn pm2 epi li kòmanse ne...')
          spawnSync('yarn', ['pm2', 'efase', 'levanter'], { cwd: 'levanter', stdio: 'inherit' })
          kòmanseNode()
        }
      }
    })
  }

  si (pm2.stdout) {
    pm2.stdout.on('done', (done) => {
      rezilta konstan = done.toString()
      konsole.log(rezilta)
      si (output.includes('Konekte')) {
        // console.log('Aplikasyon an sou entènèt.')
        rekòmanseKonte = 0
      }
    })
  }
}

fonksyon enstaleDepandans() {
  // console.log('Ap enstale depandans yo...')
  konst enstalasyonRezilta = spawnSync(
    fil
    ['enstale', '--fòse', '--non-entèaktif', '--konkourans rezo', '3'],
    {
      cwd: 'lèvan',
      stdio: 'eritye',
      anvirònman: { ...process.env, CI: 'vre' }, // Asire anviwònman ki pa entèaktif
    }
  )

  si (installResult.error || installResult.status !== 0) {
    konsole.erè(
      `Echèk pou enstale depandans yo: ${
        installResult.error ? installResult.error.message : 'Erè enkoni'
      }`
    )
    process.exit(1) // Sòti nan pwosesis la si enstalasyon an echwe
  }
}

fonksyon verifyeDepandans() {
  si (!existsSync(chemen.resolve('levanter/package.json'))) {
    console.error('pa jwenn pake.json an!')
    pwosesis.sòti(1)
  }

  rezilta konst = spawnSync('fil', ['tcheke', '--verifye-pye'], {
    cwd: 'lèvan',
    stdio: 'eritye',
  })

  // Tcheke kòd sòti a pou detèmine si te gen yon erè
  si (rezilta.estati !== 0) {
    console.log('Gen kèk depandans ki manke oswa ki mal enstale.')
    enstaleDepandans()
  } sinon {
    // console.log('Tout depandans yo enstale byen.')
  }
}

fonksyon kloneRepository() {
  // console.log('Ap klone depo a...')
  konst kloneResult = spawnSync(
    'jis',
    ['klone', 'https://github.com/lyfe00011/levanter.git', 'levanter'],
    {
      stdio: 'eritye',
    }
  )

  si (klonajRezilta.erè) {
    voye yon nouvo Erè(`Echèk pou klone depo a: ${cloneResult.error.message}`)
  }

  const configPath = 'levanter/config.env'
  eseye {
    // console.log('Ap ekri nan config.env...')
    ekriFileSync(chemenkonfigirasyon, `VPS=vre\nSESSION_ID=${SESSION_ID}`)
  } trape (fè erè) {
    voye yon nouvo Erè(`Echèk pou ekri nan config.env: ${err.message}`)
  }

  enstaleDepandans()
}

si (!egzisteSync('lèvant')) {
  kloneRepository()
  tchekeDepandans()
} sinon {
  tchekeDepandans()
}

kòmansePm2()
